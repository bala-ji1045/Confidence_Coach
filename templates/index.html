<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confidence Coach - Multi-Language Speech Analyzer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<h2>Multi-Language Speech Analyzer</h2>

<div class="language-selector">
    <label for="language" id="languageLabel">Select Language:</label>
    <select id="language" onchange="onLanguageChange()">
        <option value="en-US">English</option>
        <option value="te-IN">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å (Telugu)</option>
        <option value="hi-IN">‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)</option>
    </select>
</div>

<div class="controls">
    <button onclick="startListening()" id="startButton" class="btn-primary">Start</button>
    <button onclick="stopListening()" id="stopButton" class="btn-secondary" disabled>Stop</button>
    <button onclick="resetApp()" id="resetButton" class="btn-warning">Reset</button>
    <button onclick="generateReport()" id="analyzeButton" class="btn-success">Analyze Speech</button>
</div>

<div class="status" id="status">Ready to start</div>

<h3 id="transcriptTitle">Live Transcript:</h3>
<div id="transcript" class="transcript-box"></div>

<h3 id="reportTitle">Analysis Report:</h3>
<div id="report" class="report-box"></div>

<script>
    let recognition = null;
    let isListening = false;
    let transcriptText = '';
    let languageSegments = [];

    // Initialize app on load
    document.addEventListener('DOMContentLoaded', () => {
        resetApp();
        updateUILanguage();
    });

    // Reset everything to initial state
    function resetApp() {
        if (recognition && isListening) {
            recognition.stop();
        }
        
        recognition = null;
        isListening = false;
        transcriptText = '';
        languageSegments = [];
        
        document.getElementById('transcript').innerHTML = '';
        document.getElementById('report').innerHTML = '';
        document.getElementById('language').value = 'en-US';
        document.getElementById('status').textContent = 'Ready to start';
        document.getElementById('status').className = 'status';
        
        document.getElementById('startButton').disabled = false;
        document.getElementById('stopButton').disabled = true;
        document.getElementById('analyzeButton').disabled = false;
        
        updateUILanguage();
    }

    // Handle language change
    function onLanguageChange() {
        const wasListening = isListening;
        
        if (wasListening) {
            stopListening();
        }
        
        updateUILanguage();
        
        if (wasListening) {
            setTimeout(() => startListening(), 500);
        }
    }

    // Update UI text based on language
    async function updateUILanguage() {
        const langSelect = document.getElementById('language');
        const langCode = langSelect.value.split('-')[0];
        
        try {
            const response = await fetch('/get_ui_text', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ language: langCode })
            });
            
            const data = await response.json();
            
            document.getElementById('languageLabel').textContent = data.select_language;
            document.getElementById('startButton').textContent = data.start_button;
            document.getElementById('stopButton').textContent = data.stop_button;
            document.getElementById('analyzeButton').textContent = data.analyze_button;
            document.getElementById('transcriptTitle').textContent = data.transcript_title;
            document.getElementById('reportTitle').textContent = data.report_title;
        } catch (error) {
            console.error('Error updating language:', error);
        }
    }

    // Start speech recognition
    function startListening() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        
        if (!SpeechRecognition) {
            alert("Speech Recognition is not supported in this browser. Please use Chrome, Edge, or Safari.");
            return;
        }

        recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = document.getElementById('language').value;

        recognition.onstart = () => {
            isListening = true;
            document.getElementById('status').textContent = 'üé§ Listening...';
            document.getElementById('status').className = 'status listening';
            document.getElementById('startButton').disabled = true;
            document.getElementById('stopButton').disabled = false;
            console.log("Recognition started in language:", recognition.lang);
        };

        recognition.onerror = (event) => {
            console.error("Recognition error:", event.error);
            document.getElementById('status').textContent = '‚ùå Error: ' + event.error;
            document.getElementById('status').className = 'status error';
            
            if (event.error !== 'no-speech') {
                isListening = false;
                document.getElementById('startButton').disabled = false;
                document.getElementById('stopButton').disabled = true;
            }
        };

        recognition.onend = () => {
            isListening = false;
            document.getElementById('status').textContent = '‚èπÔ∏è Stopped';
            document.getElementById('status').className = 'status stopped';
            document.getElementById('startButton').disabled = false;
            document.getElementById('stopButton').disabled = true;
            console.log("Recognition ended");
        };

        recognition.onresult = (event) => {
            let interimTranscript = '';
            
            for (let i = event.resultIndex; i < event.results.length; i++) {
                const transcript = event.results[i][0].transcript;
                
                if (event.results[i].isFinal) {
                    transcriptText += transcript + ' ';
                    
                    const currentLang = document.getElementById('language').value;
                    languageSegments.push({
                        text: transcript,
                        language: currentLang,
                        timestamp: Date.now()
                    });
                } else {
                    interimTranscript += transcript;
                }
            }
            
            const displayText = transcriptText + '<span class="interim">' + interimTranscript + '</span>';
            document.getElementById('transcript').innerHTML = displayText || '<em>Start speaking...</em>';
        };

        try {
            recognition.start();
        } catch (error) {
            console.error("Error starting recognition:", error);
            alert("Failed to start recognition. Please try again.");
        }
    }

    // Stop speech recognition
    function stopListening() {
        if (recognition && isListening) {
            recognition.stop();
        }
    }

    // Generate analysis report
    function generateReport() {
        if (!transcriptText || !transcriptText.trim()) {
            alert("Please speak something first before analyzing.");
            return;
        }

        document.getElementById('status').textContent = '‚öôÔ∏è Analyzing...';
        document.getElementById('status').className = 'status analyzing';
        document.getElementById('analyzeButton').disabled = true;
        
        const requestData = {
            transcript: transcriptText.trim(),
            language: document.getElementById('language').value.split('-')[0],
            languageSegments: languageSegments
        };
        
        fetch('/analyze', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestData)
        })
        .then(res => res.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
                return;
            }

            const report = `
                <div class="report-section">
                    <h4>${data.templates.analysis_summary}</h4>
                    <div class="confidence-feedback">${data.confidence_feedback}</div>
                    <div class="confidence-score">
                        <div class="score-circle" style="background: conic-gradient(#4CAF50 ${data.confidence_score * 3.6}deg, #e0e0e0 0deg)">
                            <div class="score-inner">
                                <span class="score-text">${data.confidence_score}%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="report-section">
                    <h4>${data.templates.speech_markers}</h4>
                    <div class="markers-grid">
                        <div class="marker-item">
                            <span class="marker-label">${data.templates.hesitations}</span>
                            <span class="marker-value">${data.confidence_markers.hesitations}</span>
                        </div>
                        <div class="marker-item">
                            <span class="marker-label">${data.templates.repetitions}</span>
                            <span class="marker-value">${data.confidence_markers.repetitions}</span>
                        </div>
                        <div class="marker-item">
                            <span class="marker-label">${data.templates.filler_count}</span>
                            <span class="marker-value">${data.confidence_markers.filler_words}</span>
                        </div>
                    </div>
                </div>

                ${data.low_confidence_segments.length > 0 ? `
                    <div class="report-section">
                        <h4>${data.templates.areas_to_improve}</h4>
                        <div class="segments-list">
                            ${data.low_confidence_segments.map(segment => `
                                <div class="segment-item">
                                    <p class="segment-text">"${segment.text}"</p>
                                    <p class="segment-confidence">Confidence: ${Math.round(segment.confidence * 100)}%</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}

                ${data.recommendations.length > 0 ? `
                    <div class="report-section">
                        <h4>${data.templates.recommendations}</h4>
                        <ul class="recommendations-list">
                            ${data.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
            `;
            
            document.getElementById('report').innerHTML = report;
            document.getElementById('status').textContent = '‚úÖ Analysis Complete';
            document.getElementById('status').className = 'status success';
            document.getElementById('analyzeButton').disabled = false;
        })
        .catch(err => {
            console.error("Error:", err);
            alert("Failed to analyze. Please try again.");
            document.getElementById('status').textContent = '‚ùå Analysis Failed';
            document.getElementById('status').className = 'status error';
            document.getElementById('analyzeButton').disabled = false;
        });
    }
</script>

</body>
</html>
